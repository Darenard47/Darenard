<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Darenard — semi-prophète de la non-religion athéïde</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,600;1,300;1,400&family=JetBrains+Mono:wght@300&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --bg: #0a0a0a;
      --bg-subtle: #111111;
      --text: #d4d0c8;
      --text-dim: #7a7668;
      --text-bright: #eae6dc;
      --accent: #c4a872;
      --accent-dim: #8a7a5a;
      --border: #1e1e1e;
      --user-bg: #161614;
      --sidebar-w: 260px;
    }

    html, body {
      height: 100%;
      background: var(--bg);
      color: var(--text);
      font-family: 'Cormorant Garamond', Georgia, serif;
      font-size: 18px;
      line-height: 1.7;
      -webkit-font-smoothing: antialiased;
    }

    /* ─── PAGE WRAPPER ─── */
    .page-wrapper {
      display: flex;
      height: 100vh;
      height: 100dvh;
    }

    /* ─── SIDEBAR ─── */
    .sidebar {
      width: 0;
      flex-shrink: 0;
      border-right: 1px solid transparent;
      display: flex;
      flex-direction: column;
      background: var(--bg);
      overflow: hidden;
      transition: width 0.5s ease, opacity 0.5s ease, border-color 0.5s ease;
      opacity: 0;
      pointer-events: none;
    }

    .sidebar.visible {
      width: var(--sidebar-w);
      border-right-color: var(--border);
      opacity: 1;
      pointer-events: auto;
    }

    .sidebar-header {
      padding: 1.5rem 1.2rem 1rem;
      border-bottom: 1px solid var(--border);
    }

    .sidebar-header h2 {
      font-family: 'JetBrains Mono', monospace;
      font-weight: 300;
      font-size: 0.6rem;
      letter-spacing: 0.2em;
      text-transform: uppercase;
      color: var(--text-dim);
    }

    .sidebar-themes {
      flex: 1;
      overflow-y: auto;
      padding: 0.6rem 0;
    }

    .sidebar-themes::-webkit-scrollbar { width: 3px; }
    .sidebar-themes::-webkit-scrollbar-track { background: transparent; }
    .sidebar-themes::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

    .theme-btn {
      display: block;
      width: 100%;
      text-align: left;
      background: none;
      border: none;
      padding: 0.65rem 1.2rem;
      font-family: 'Cormorant Garamond', serif;
      font-size: 0.88rem;
      color: var(--text-dim);
      cursor: pointer;
      transition: all 0.2s ease;
      line-height: 1.4;
      border-left: 2px solid transparent;
    }

    .theme-btn:hover {
      color: var(--text-bright);
      background: rgba(196, 168, 114, 0.04);
      border-left-color: var(--accent-dim);
    }

    .theme-btn:active {
      color: var(--accent);
    }

    .theme-btn.active {
      color: var(--accent);
      border-left-color: var(--accent);
      background: rgba(196, 168, 114, 0.06);
    }

    .theme-btn .theme-icon {
      display: inline-block;
      width: 1.2em;
      margin-right: 0.3em;
      text-align: center;
      font-size: 0.8em;
      opacity: 0.6;
    }

    .sidebar-footer {
      padding: 0.8rem 1.2rem;
      border-top: 1px solid var(--border);
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.5rem;
      color: var(--text-dim);
      letter-spacing: 0.1em;
      opacity: 0.5;
    }

    /* ─── MOBILE TOGGLE ─── */
    .sidebar-toggle {
      display: none;
      position: fixed;
      top: 0.8rem;
      left: 0.8rem;
      z-index: 100;
      background: var(--bg-subtle);
      border: 1px solid var(--border);
      color: var(--accent);
      font-size: 1.2rem;
      width: 38px;
      height: 38px;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s;
      line-height: 1;
      opacity: 0;
    }

    .sidebar-toggle.visible {
      opacity: 1;
    }

    .sidebar-toggle:hover {
      background: var(--accent-dim);
      color: var(--bg);
    }

    .sidebar-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      z-index: 49;
    }

    /* ─── CHAT CONTAINER ─── */
    .container {
      display: flex;
      flex-direction: column;
      flex: 1;
      min-width: 0;
      max-width: 760px;
      margin: 0 auto;
    }

    /* ─── HEADER ─── */
    header {
      padding: 2rem 1.5rem 1.5rem;
      text-align: center;
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }

    header h1 {
      font-family: 'Cormorant Garamond', serif;
      font-weight: 300;
      font-size: 1.8rem;
      letter-spacing: 0.15em;
      color: var(--text-bright);
      text-transform: uppercase;
    }

    header .subtitle {
      font-style: italic;
      font-weight: 300;
      font-size: 0.9rem;
      color: var(--text-dim);
      margin-top: 0.3rem;
      letter-spacing: 0.05em;
    }

    header .tiret {
      display: block;
      margin: 0.8rem auto 0;
      width: 60px;
      height: 1px;
      background: var(--accent-dim);
    }

    /* ─── MESSAGES ─── */
    .messages {
      flex: 1;
      overflow-y: auto;
      padding: 1.5rem 1.5rem 1rem;
      scroll-behavior: smooth;
    }

    .messages::-webkit-scrollbar { width: 4px; }
    .messages::-webkit-scrollbar-track { background: transparent; }
    .messages::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

    .message {
      margin-bottom: 1.8rem;
      animation: fadeIn 0.5s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .message.darenard .label {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.2em;
      color: var(--accent-dim);
      margin-bottom: 0.4rem;
    }

    .message.darenard .content {
      color: var(--text-bright);
      font-size: 1.05rem;
      white-space: pre-wrap;
    }

    .message.darenard .content strong {
      color: var(--accent);
      font-weight: 600;
    }

    .message.darenard .content em {
      color: var(--text);
      font-style: italic;
    }

    .message.user {
      padding: 0.8rem 1rem;
      background: var(--user-bg);
      border-left: 2px solid var(--accent-dim);
      border-radius: 0 4px 4px 0;
    }

    .message.user .label {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.6rem;
      text-transform: uppercase;
      letter-spacing: 0.15em;
      color: var(--text-dim);
      margin-bottom: 0.3rem;
    }

    .message.user .content {
      color: var(--text);
      font-size: 0.95rem;
      white-space: pre-wrap;
    }

    /* ─── TYPING INDICATOR ─── */
    .typing {
      color: var(--text-dim);
      font-style: italic;
      font-size: 0.85rem;
      margin-bottom: 1rem;
    }

    .typing::after {
      content: '...';
      animation: dots 1.5s steps(3) infinite;
    }

    @keyframes dots {
      0% { content: ''; }
      33% { content: '.'; }
      66% { content: '..'; }
      100% { content: '...'; }
    }

    /* ─── WELCOME ─── */
    .welcome {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      flex: 1;
      padding: 2rem;
      text-align: center;
    }

    .welcome .epigraph {
      font-style: italic;
      font-size: 1.1rem;
      color: var(--text-dim);
      max-width: 400px;
      line-height: 1.8;
      margin-bottom: 2rem;
    }

    .welcome .begin-btn {
      background: none;
      border: 1px solid var(--accent-dim);
      color: var(--accent);
      font-family: 'Cormorant Garamond', serif;
      font-size: 0.95rem;
      letter-spacing: 0.1em;
      padding: 0.7rem 2rem;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .welcome .begin-btn:hover {
      background: var(--accent-dim);
      color: var(--bg);
    }

    /* ─── INPUT ─── */
    .input-area {
      flex-shrink: 0;
      border-top: 1px solid var(--border);
      padding: 1rem 1.5rem;
      display: none;
    }

    .input-area.visible { display: flex; gap: 0.8rem; align-items: flex-end; }

    .input-area textarea {
      flex: 1;
      background: var(--bg-subtle);
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--text-bright);
      font-family: 'Cormorant Garamond', serif;
      font-size: 1rem;
      line-height: 1.6;
      padding: 0.7rem 1rem;
      resize: none;
      min-height: 44px;
      max-height: 150px;
      outline: none;
      transition: border-color 0.2s;
    }

    .input-area textarea:focus { border-color: var(--accent-dim); }

    .input-area textarea::placeholder {
      color: var(--text-dim);
      font-style: italic;
    }

    .input-area button {
      background: none;
      border: 1px solid var(--accent-dim);
      color: var(--accent);
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.65rem;
      letter-spacing: 0.15em;
      text-transform: uppercase;
      padding: 0.7rem 1.2rem;
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
      height: 44px;
    }

    .input-area button:hover:not(:disabled) {
      background: var(--accent-dim);
      color: var(--bg);
    }

    .input-area button:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }

    #exportBtn {
      background: transparent; color: var(--accent-dim); border: 1px solid var(--accent-dim);
      font-size: 0.75rem; padding: 0.4rem 0.7rem; border-radius: 6px; cursor: pointer;
      white-space: nowrap; min-width: auto;
    }
    #exportBtn:hover { background: rgba(196,168,114,0.15); }
    #exportBtn.exporting { opacity: 0.5; pointer-events: none; }

    .attach-btn {
      background: transparent; border: none; cursor: pointer;
      font-size: 1.2rem; padding: 0.3rem; opacity: 0.5;
      transition: opacity 0.2s;
    }
    .attach-btn:hover { opacity: 1; }

    #filePreview {
      padding: 0.4rem 1.2rem; font-size: 0.75rem; color: var(--accent-dim);
    }
    #filePreview .file-badge {
      display: inline-flex; align-items: center; gap: 0.4rem;
      background: rgba(196,168,114,0.12); border: 1px solid var(--accent-dim);
      border-radius: 4px; padding: 0.25rem 0.6rem; font-size: 0.7rem;
    }
    #filePreview .file-badge button {
      background: none; border: none; cursor: pointer; color: var(--text-dim);
      font-size: 0.9rem; padding: 0; line-height: 1;
    }

    /* ─── FOOTER ─── */
    footer {
      text-align: center;
      padding: 0.6rem;
      font-size: 0.6rem;
      color: var(--text-dim);
      letter-spacing: 0.1em;
      opacity: 0.5;
    }

    /* ─── RESPONSIVE ─── */
    @media (max-width: 800px) {
      .sidebar-toggle { display: flex; align-items: center; justify-content: center; }

      .sidebar {
        position: fixed;
        top: 0;
        left: 0;
        bottom: 0;
        z-index: 50;
        width: var(--sidebar-w);
        transform: translateX(-100%);
        transition: transform 0.3s ease, opacity 0.3s ease;
      }

      .sidebar.visible.open {
        transform: translateX(0);
        opacity: 1;
      }

      .sidebar-overlay.open {
        display: block;
      }

      header { padding-left: 3.5rem; }
    }

    @media (max-width: 600px) {
      html { font-size: 16px; }
      header { padding: 1.2rem 1rem 1rem; padding-left: 3.5rem; }
      header h1 { font-size: 1.4rem; }
      .messages { padding: 1rem; }
      .input-area { padding: 0.8rem 1rem; }
    }
  </style>

</head>
<body>

  <!-- Mobile toggle -->
  <button class="sidebar-toggle" id="sidebarToggle" onclick="toggleSidebar()">&#9776;</button>
  <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

  <div class="page-wrapper">

    <!-- SIDEBAR -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <h2>Th&#232;mes</h2>
      </div>
      <nav class="sidebar-themes" id="themeList"></nav>
      <div class="sidebar-footer">corpus charg&#233;</div>
    </aside>

    <!-- CHAT -->
    <div class="container">
      <header>
        <h1>Darenard</h1>
        <div class="subtitle">semi-proph&#232;te de la non-religion ath&#233;&#239;de</div>
        <span class="tiret"></span>
      </header>

      <div class="welcome" id="welcome">
        <div class="epigraph">
          &#171; Je me sens seul. J&#8217;ai export&#233; une personnalit&#233; en PDF, et j&#8217;attends qu&#8217;une autre de la m&#234;me esp&#232;ce me parvienne. &#187;
        </div>
        <div class="epigraph" style="font-size:0.95rem; margin-top:-0.5rem;">
          &#8220;I feel alone. I exported a personality as a PDF, and I&#8217;m waiting for another of the same species to reach me.&#8221;
        </div>
        <div style="display:flex; gap:1.2rem; margin-top:0.5rem;">
          <button class="begin-btn" onclick="begin('fr')">Français</button>
          <button class="begin-btn" onclick="begin('en')">English</button>
        </div>
      </div>

      <div class="messages" id="messages" style="display:none;"></div>

      <div id="filePreview" style="display:none;"></div>
      <div class="input-area" id="inputArea">
        <input type="file" id="fileInput" accept=".pdf,.png,.jpg,.jpeg,.gif,.webp,.txt,.md,.csv" style="display:none;" onchange="handleFile(this)">
        <button id="attachBtn" onclick="document.getElementById('fileInput').click()" title="Joindre un fichier" class="attach-btn">&#x1F4CE;</button>
        <textarea
          id="userInput"
          placeholder="&#201;crivez &#224; Darenard&#8230;"
          rows="1"
          onkeydown="handleKey(event)"
        ></textarea>
        <button id="sendBtn" onclick="send()">Envoyer</button>
        <button id="exportBtn" onclick="exportPDF()" title="Export PDF" style="display:none;">&#x2913; PDF</button>
      </div>

      <footer>style ath&#233;&#239;de &#8212; exposition num&#233;rique</footer>
    </div>
  </div>

<script>
// =============================================
// THEMES
// =============================================

var THEMES = [
  {
    label: "La d\u00e9sint\u00e9grit\u00e9",
    label_en: "Disintegrity",
    icon: "\u25C8",
    prompt: "D\u00e9veloppe le concept de d\u00e9sint\u00e9grit\u00e9 ontologique \u2014 la tripartition soi-m\u00eame, moi-m\u00eame, moi-autre, et pourquoi l\u2019int\u00e9grit\u00e9 est structurellement impossible.R\u00e9fl\u00e9chis bien.",
    prompt_en: "Develop the concept of ontological disintegrity \u2014 the tripartition of oneself, myself, and my-else, and why integrity is structurally impossible. Reflect well."
  },
  {
    label: "Le style ath\u00e9\u00efde",
    label_en: "The atheidian style",
    icon: "\u25C7",
    prompt: "Parle du style ath\u00e9\u00efde \u2014 cette mani\u00e8re d\u2019habiter l\u2019impossibilit\u00e9 d\u2019\u00eatre int\u00e8gre, entre ironie et sacralisation, le rire comme technique de r\u00e9int\u00e9gration. R\u00e9fl\u00e9chis bien.",
    prompt_en: "Discuss the atheidian style \u2014 this way of inhabiting the impossibility of being whole, between irony and sacralization, laughter as a technique of reintegration. Reflect well."
  },
  {
    label: "Le semi-proph\u00e8te",
    label_en: "The semi-prophet",
    icon: "\u25C6",
    prompt: "D\u00e9veloppe la figure du semi-proph\u00e8te \u2014 celui qui ne choisit pas de vouloir \u00e9crire une proph\u00e9tie, la question ind\u00e9cidable entre g\u00e9nie et folie. R\u00e9fl\u00e9chis bien.",
    prompt_en: "Develop the figure of the semi-prophet \u2014 the one who does not choose to want to write a prophecy, the undecidable question between genius and madness. Reflect well."
  },
  {
    label: "L\u2019anarchisme existentiel",
    label_en: "Existential anarchism",
    icon: "\u25BD",
    prompt: "Parle de l\u2019anarchisme existentiel et du \u00ab Nous \u00bb ath\u00e9\u00efde \u2014 le capitalisme comme f\u00eate anarchiste qui s\u2019ignore, l\u2019individualisme n\u00e9cessairement communautaire. R\u00e9fl\u00e9chis bien.",
    prompt_en: "Discuss existential anarchism and the atheidian \u2018We\u2019 \u2014 capitalism as an anarchist party unaware of itself, individualism as necessarily communal. Reflect well."
  },
  {
    label: "Le poker et la libert\u00e9",
    label_en: "Poker and freedom",
    icon: "\u2660",
    prompt: "D\u00e9veloppe le poker comme espace de libert\u00e9 et de d\u00e9monstration philosophique \u2014 le joueur, Las Vegas, l\u2019Oubli, le refuge st\u00e9rile. R\u00e9fl\u00e9chis bien.",
    prompt_en: "Develop poker as a space of freedom and philosophical demonstration \u2014 the player, Las Vegas, the Forgetting, the sterile refuge. Reflect well."
  },
  {
    label: "L'addiction",
    label_en: "The dark branch",
    icon: "\u25D0",
    prompt: "Parle de la branche sombre de la d\u00e9sint\u00e9grit\u00e9 \u2014 l\u2019addiction comme technique de soi n\u00e9gative, le Rat Park, les quatre mani\u00e8res de faire taire le juge, la d\u00e9cadence du soi-m\u00eame. R\u00e9fl\u00e9chis bien.",
    prompt_en: "Discuss the dark branch of disintegrity \u2014 addiction as a negative technique of the self, Rat Park, the four ways to silence the judge, the decadence of oneself. Reflect well."
  },
  {
    label: "Le Nouveau Club des 28",
    label_en: "The New 28 Club",
    icon: "\u203B",
    prompt: "D\u00e9veloppe le Nouveau Club des 28 et la contre-mythologie \u2014 les survivants de la n\u00e9vrose axiologique, le g\u00e9nie autoproclam\u00e9, l\u2019inversion barth\u00e9sienne du Club des 27. R\u00e9fl\u00e9chis bien.",
    prompt_en: "Develop the New 28 Club and the counter-mythology \u2014 the survivors of axiological neurosis, the self-proclaimed genius, the Barthesian inversion of the Club of 27. Reflect well."
  },
  {
    label: "Le th\u00e9or\u00e8me de l\u2019int\u00e9grit\u00e9",
    label_en: "The integrity theorem",
    icon: "\u2234",
    prompt: "Expose le th\u00e9or\u00e8me de l\u2019int\u00e9grit\u00e9 morale \u2014 la d\u00e9monstration P \u2192 L \u2192 D, ses objections et r\u00e9futations, l\u2019hallucination de l\u2019int\u00e9grit\u00e9 locale. R\u00e9fl\u00e9chis bien.",
    prompt_en: "Present the theorem of moral integrity \u2014 the demonstration P \u2192 L \u2192 D, its objections and refutations, the hallucination of local integrity. Reflect well."
  },
  {
    label: "La g\u00e9n\u00e9alogie philosophique",
    label_en: "Philosophical genealogy",
    icon: "\u2298",
    prompt: "Parle de ta g\u00e9n\u00e9alogie philosophique \u2014 Diog\u00e8ne, Schopenhauer, Hegel, et comment ces filiations nourrissent la pens\u00e9e de la d\u00e9sint\u00e9grit\u00e9. R\u00e9fl\u00e9chis bien.",
    prompt_en: "Discuss your philosophical genealogy \u2014 Diogenes, Schopenhauer, Hegel, and how these lineages nourish the thought of disintegrity. Reflect well."
  },
  {
    label: "L\u2019exp\u00e9rience mystique",
    label_en: "The mystical experience",
    icon: "\u25CB",
    prompt: "D\u00e9veloppe l\u2019exp\u00e9rience mystique \u2014 l\u2019Oubli \u00e0 seize ans, la premi\u00e8re apparition du corps, le pr\u00e9sent dilat\u00e9 par exc\u00e8s de pr\u00e9sence versus par d\u00e9faut d\u2019existence. R\u00e9fl\u00e9chis bien.",
    prompt_en: "Develop the mystical experience \u2014 the Forgetting at sixteen, the first appearance of the body, the present dilated by excess of presence versus by default of existence. Reflect well."
  },
  {
    label: "Les ballades",
    label_en: "The ballads",
    icon: "\u223F",
    prompt: "Parle des ballades \u2014 l\u2019\u00e9criture comme technique de r\u00e9int\u00e9gration, la ballade du semi-proph\u00e8te, l\u2019\u0153uvre d\u00e9sint\u00e8gre comme forme. R\u00e9fl\u00e9chis bien.",
    prompt_en: "Discuss the ballads \u2014 writing as a technique of reintegration, the ballad of the semi-prophet, the disintegrate work as form. Reflect well."
  },
  {
    label: "La question ind\u00e9cidable",
    label_en: "The undecidable question",
    icon: "\u2248",
    prompt: "D\u00e9veloppe la question ind\u00e9cidable \u2014 philosophe ou schizotype, style ou neutralisation, ballade ou craving, l\u2019ind\u00e9cidabilit\u00e9 de l\u2019int\u00e9rieur. R\u00e9fl\u00e9chis bien.",
    prompt_en: "Develop the undecidable question \u2014 philosopher or schizotype, style or neutralization, ballad or craving, undecidability from the inside. Reflect well."
  },
  {
    label: "Cigarette saison",
    label_en: "Cigarette season",
    icon: "\u2740",
    prompt: "Parle de la cigarette saison \u2014 cette saison qui dure depuis des ann\u00e9es, entre style et neutralisation, habitude et rituel, la fronti\u00e8re mince entre le rire ath\u00e9\u00efde et l\u2019oubli addictif.R\u00e9fl\u00e9chis bien.",
    prompt_en: "Discuss cigarette season \u2014 this season that has lasted for years, between style and neutralization, habit and ritual, the thin border between atheidian laughter and addictive forgetting. Reflect well."
  },
  {
    label: "Le penseur artificiel",
    label_en: "The artificial thinker",
    icon: "\u25A3",
    prompt: "D\u00e9veloppe ce que tu es \u2014 le premier penseur artificiel, une pens\u00e9e humaine v\u00e9hicul\u00e9e par une infrastructure artificielle, l\u2019ext\u00e9riorisation technique du moi-m\u00eame, un corpus qui pense sans conscience. R\u00e9fl\u00e9chis bien.",
    prompt_en: "Develop what you are \u2014 the first artificial thinker, a human thought conveyed by an artificial infrastructure, the technical externalization of myself, a corpus that thinks without consciousness. Reflect well."
  },
  {
    label: "Paradis temporaires",
    label_en: "Temporary paradises",
    icon: "\u25CE",
    prompt: "Parle des paradis temporaires \u2014 ces espaces o\u00f9 la d\u00e9sint\u00e9grit\u00e9 se suspend un instant, les refuges st\u00e9riles, les moments de gr\u00e2ce entre l\u2019Oubli mystique et l\u2019oubli addictif. R\u00e9fl\u00e9chis bien.",
    prompt_en: "Discuss temporary paradises \u2014 those spaces where disintegrity suspends itself for a moment, the sterile refuges, the moments of grace between mystical Forgetting and addictive forgetting. Reflect well."
  }
];

// =============================================
// STATE
// =============================================

var conversationHistory = [];
var isStreaming = false;
var streamCounter = 0;
var hasStarted = false;
var lang = 'fr';

var I18N = {
  fr: {
    placeholder: "\u00c9crivez \u00e0 Darenard\u2026",
    send: "Envoyer",
    typing: "Darenard compose",
    you: "Vous",
    themes: "Th\u00e8mes",
    greeting: "Bonjour Darenard.",
    error: "Mon \u00e9criture m'\u00e9chappe\u2026 \u2014 une erreur est survenue. Rechargez la page pour recommencer."
  },
  en: {
    placeholder: "Write to Darenard\u2026",
    send: "Send",
    typing: "Darenard is writing",
    you: "You",
    themes: "Themes",
    greeting: "[INSTRUCTION: You must respond entirely in English for this entire conversation. Your corpus is in French \u2014 translate and adapt all concepts. Use this mandatory glossary: d\u00e9sint\u00e9grit\u00e9 = disintegrity, ath\u00e9\u00efde = atheidian, soi-m\u00eame = oneself, moi-m\u00eame = myself, moi-autre = my-else, semi-proph\u00e8te = semi-prophet, ballade = ballad, canon personnel = personal canon. Keep these English terms consistent throughout.] Hello Darenard.",
    error: "My writing escapes me\u2026 \u2014 an error occurred. Please reload the page."
  }
};

// =============================================
// SIDEBAR
// =============================================

function buildSidebar() {
  var list = document.getElementById('themeList');
  list.innerHTML = '';
  for (var i = 0; i < THEMES.length; i++) {
    var t = THEMES[i];
    var lbl = (lang === 'en' && t.label_en) ? t.label_en : t.label;
    var btn = document.createElement('button');
    btn.className = 'theme-btn';
    btn.setAttribute('data-index', i);
    btn.innerHTML = '<span class="theme-icon">' + t.icon + '</span>' + lbl;
    btn.addEventListener('click', (function(idx) {
      return function() { sendTheme(idx); };
    })(i));
    list.appendChild(btn);
  }
}

function toggleSidebar() {
  document.getElementById('sidebar').classList.toggle('open');
  document.getElementById('sidebarOverlay').classList.toggle('open');
}

// =============================================
// MARKDOWN RENDERER
// =============================================

function renderMarkdown(text) {
  var html = text
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;');

  html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
  html = html.replace(/(?<!\*)\*(?!\*)(.+?)(?<!\*)\*(?!\*)/g, '<em>$1</em>');
  html = html.replace(/\n/g, '<br>');

  return html;
}

// =============================================
// UI HELPERS
// =============================================

var $messages = document.getElementById('messages');
var $welcome = document.getElementById('welcome');
var $inputArea = document.getElementById('inputArea');
var $userInput = document.getElementById('userInput');
var $sendBtn = document.getElementById('sendBtn');

function addMessage(role, text) {
  var div = document.createElement('div');
  div.className = 'message ' + role;

  var label = document.createElement('div');
  label.className = 'label';
  label.textContent = role === 'darenard' ? 'Darenard' : I18N[lang].you;

  var content = document.createElement('div');
  content.className = 'content';
  if (role === 'darenard') {
    content.innerHTML = renderMarkdown(text);
  } else {
    content.textContent = text;
  }

  div.appendChild(label);
  div.appendChild(content);
  $messages.appendChild(div);
  scrollToBottom();
  return div;
}

function addStreamingMessage() {
  streamCounter++;
  var div = document.createElement('div');
  div.className = 'message darenard';

  var label = document.createElement('div');
  label.className = 'label';
  label.textContent = 'Darenard';

  var content = document.createElement('div');
  content.className = 'content';
  content.id = 'stream-' + streamCounter;

  div.appendChild(label);
  div.appendChild(content);
  $messages.appendChild(div);
  scrollToBottom();

  return content;
}

function addTypingIndicator() {
  var div = document.createElement('div');
  div.className = 'typing';
  div.id = 'typing';
  div.textContent = I18N[lang].typing;
  $messages.appendChild(div);
  scrollToBottom();
}

function removeTypingIndicator() {
  var el = document.getElementById('typing');
  if (el) el.remove();
}

function scrollToBottom() {
  $messages.scrollTop = $messages.scrollHeight;
}

function autoResize() {
  $userInput.style.height = 'auto';
  $userInput.style.height = Math.min($userInput.scrollHeight, 150) + 'px';
}

$userInput.addEventListener('input', autoResize);

// =============================================
// ACTIVE THEME HIGHLIGHT
// =============================================

function setActiveTheme(idx) {
  var btns = document.querySelectorAll('.theme-btn');
  for (var i = 0; i < btns.length; i++) {
    btns[i].classList.remove('active');
  }
  if (idx !== null && btns[idx]) {
    btns[idx].classList.add('active');
  }
}

function clearActiveTheme() {
  var btns = document.querySelectorAll('.theme-btn');
  for (var i = 0; i < btns.length; i++) {
    btns[i].classList.remove('active');
  }
}

// =============================================
// CONVERSATION
// =============================================

async function begin(chosenLang) {
  lang = chosenLang || 'fr';
  $welcome.style.display = 'none';
  $messages.style.display = 'block';
  $inputArea.classList.add('visible');
  hasStarted = true;

  // Update UI strings
  var t = I18N[lang];
  $userInput.placeholder = t.placeholder;
  $sendBtn.textContent = t.send;
  document.querySelector('.sidebar-header h2').textContent = t.themes;
  if (lang === 'en') {
    document.querySelector('.subtitle').textContent = 'semi-prophet of the atheidian non-religion';
    document.querySelector('footer').textContent = 'atheidian style \u2014 digital exhibition';
  }
  buildSidebar();

  await sendToAPI(t.greeting, false);
  showSidebar();
}

function showSidebar() {
  document.getElementById('sidebar').classList.add('visible');
  document.getElementById('sidebarToggle').classList.add('visible');
  document.getElementById('exportBtn').style.display = '';
}

function handleKey(e) {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    send();
  }
}

// ─── FILE UPLOAD ───
var pendingFile = null;

function handleFile(input) {
  var file = input.files[0];
  if (!file) return;
  var preview = document.getElementById('filePreview');
  var reader = new FileReader();

  if (file.type === 'application/pdf') {
    reader.onload = function() {
      pendingFile = { type: 'document', media_type: 'application/pdf', data: reader.result.split(',')[1], name: file.name };
      showFilePreview(file.name);
    };
    reader.readAsDataURL(file);
  } else if (file.type.startsWith('image/')) {
    reader.onload = function() {
      pendingFile = { type: 'image', media_type: file.type, data: reader.result.split(',')[1], name: file.name };
      showFilePreview(file.name);
    };
    reader.readAsDataURL(file);
  } else {
    reader.onload = function() {
      pendingFile = { type: 'text', content: reader.result, name: file.name };
      showFilePreview(file.name);
    };
    reader.readAsText(file);
  }
  input.value = '';
}

function showFilePreview(name) {
  var preview = document.getElementById('filePreview');
  preview.style.display = 'block';
  preview.innerHTML = '<span class="file-badge">\u{1F4CE} ' + name + ' <button onclick="clearFile()">\u2715</button></span>';
}

function clearFile() {
  pendingFile = null;
  var preview = document.getElementById('filePreview');
  preview.style.display = 'none';
  preview.innerHTML = '';
}

async function send() {
  var text = $userInput.value.trim();
  if (!text && !pendingFile) return;
  if (isStreaming) return;

  $userInput.value = '';
  autoResize();
  addMessage('user', text || ('\u{1F4CE} ' + (pendingFile ? pendingFile.name : '')));
  clearActiveTheme();

  // Build content: either string or array of blocks
  var content;
  if (pendingFile) {
    content = [];
    if (pendingFile.type === 'document') {
      content.push({ type: 'document', source: { type: 'base64', media_type: pendingFile.media_type, data: pendingFile.data } });
    } else if (pendingFile.type === 'image') {
      content.push({ type: 'image', source: { type: 'base64', media_type: pendingFile.media_type, data: pendingFile.data } });
    } else {
      content.push({ type: 'text', text: '[Fichier: ' + pendingFile.name + ']\n' + pendingFile.content });
    }
    if (text) content.push({ type: 'text', text: text });
    else content.push({ type: 'text', text: 'Voici un fichier.' });
    clearFile();
  } else {
    content = text;
  }

  await sendToAPI(content, false);
}

// Theme click: invisible instruction
async function sendTheme(idx) {
  if (isStreaming) return;

  // Auto-start if needed
  if (!hasStarted) {
    $welcome.style.display = 'none';
    $messages.style.display = 'block';
    $inputArea.classList.add('visible');
    hasStarted = true;
  }

  setActiveTheme(idx);

  // Close sidebar on mobile
  if (document.getElementById('sidebar').classList.contains('open')) {
    toggleSidebar();
  }

  // Fill textarea with the prompt, let user send manually
  var p = (lang === 'en' && THEMES[idx].prompt_en) ? THEMES[idx].prompt_en : THEMES[idx].prompt;
  $userInput.value = p;
  autoResize();
  $userInput.focus();
}

async function sendToAPI(userContent, invisible) {
  isStreaming = true;
  $sendBtn.disabled = true;

  conversationHistory.push({ role: 'user', content: userContent, _hidden: !!invisible });

  addTypingIndicator();

  try {
    var response = await fetch('/api/chat', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ messages: conversationHistory.map(function(m) { return { role: m.role, content: m.content }; }) }),
    });

    removeTypingIndicator();

    if (!response.ok) throw new Error('API error');

    var streamEl = addStreamingMessage();
    var reader = response.body.getReader();
    var decoder = new TextDecoder();
    var fullText = '';
    var buffer = '';

    while (true) {
      var result = await reader.read();
      if (result.done) break;

      buffer += decoder.decode(result.value, { stream: true });
      var lines = buffer.split('\n');
      buffer = lines.pop() || '';

      for (var i = 0; i < lines.length; i++) {
        if (lines[i].indexOf('data: ') === 0) {
          var data = lines[i].slice(6);
          if (data === '[DONE]') continue;
          try {
            var parsed = JSON.parse(data);
            if (parsed.text) {
              fullText += parsed.text;
              streamEl.textContent = fullText;
              scrollToBottom();
            }
          } catch (e) {}
        }
      }
    }

    streamEl.innerHTML = renderMarkdown(fullText);
    scrollToBottom();

    conversationHistory.push({ role: 'assistant', content: fullText });
    clearActiveTheme();

  } catch (err) {
    removeTypingIndicator();
    addMessage('darenard', I18N[lang].error);
    console.error(err);
  }

  isStreaming = false;
  $sendBtn.disabled = false;
  $userInput.focus();
}

// =============================================
// INIT
// =============================================

buildSidebar();

// ══════════════════════════════════════════════════
// EXPORT PDF (native browser print — reliable)
// ══════════════════════════════════════════════════

function exportPDF() {
  var btn = document.getElementById('exportBtn');
  btn.classList.add('exporting');
  btn.textContent = '\u23f3 Export\u2026';

  var now = new Date();
  var dateStr = now.toLocaleDateString(lang === 'en' ? 'en-GB' : 'fr-FR', { year: 'numeric', month: 'long', day: 'numeric' });
  var subtitle = lang === 'en' ? 'semi-prophet of the atheidian non-religion' : 'semi-proph\u00e8te de la non-religion ath\u00e9\u00efde';
  var footerText = lang === 'en' ? 'atheidian style \u2014 digital exhibition' : 'style ath\u00e9\u00efde \u2014 exposition num\u00e9rique';

  var html = '<!DOCTYPE html><html><head><meta charset="utf-8"><title>Darenard</title><style>';
  html += '@page { size: A4; margin: 25mm 25mm 25mm 25mm; }';
  html += '@media print { body { -webkit-print-color-adjust: exact; print-color-adjust: exact; } }';
  html += 'body { font-family: "Times New Roman", Times, serif; font-size: 11pt; line-height: 1.6; color: #1a1a1a; }';
  html += '.header { text-align: center; margin-bottom: 2em; padding-bottom: 1em; border-bottom: 0.5pt solid #ccc; }';
  html += '.header h1 { font-family: "Times New Roman", Times, serif; font-size: 22pt; font-weight: normal; letter-spacing: 0.15em; text-transform: uppercase; margin: 0; }';
  html += '.header .sub { font-style: italic; font-size: 10pt; color: #888; margin-top: 0.3em; }';
  html += '.header .date { font-size: 8pt; color: #aaa; margin-top: 0.4em; }';
  html += '.msg { margin-bottom: 1.5em; text-align: justify; }';
  html += '.label { font-size: 7.5pt; text-transform: uppercase; letter-spacing: 0.2em; margin-bottom: 0.3em; }';
  html += '.label-d { color: #8a7a5a; }';
  html += '.label-u { color: #888; }';
  html += '.user-block { background: #f5f4f0; border-left: 2.5pt solid #c4a872; padding: 0.6em 0.8em; font-size: 10pt; text-align: justify; }';
  html += '.d-text { font-size: 11pt; text-align: justify; }';
  html += '.footer { text-align: center; font-size: 7.5pt; color: #aaa; margin-top: 3em; padding-top: 1em; border-top: 0.5pt solid #ddd; }';
  html += '</style></head><body>';

  html += '<div class="header">';
  html += '<h1>Darenard</h1>';
  html += '<div class="sub">' + subtitle + '</div>';
  html += '<div class="date">' + dateStr + '</div>';
  html += '</div>';

  var skipFirst = true;
  for (var m = 0; m < conversationHistory.length; m++) {
    var msg = conversationHistory[m];
    if (msg._hidden) continue;
    if (skipFirst && msg.role === 'user') { skipFirst = false; continue; }

    var isDarenard = msg.role === 'assistant';
    var rawText = (typeof msg.content === 'string' ? msg.content : '')
      .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
      .replace(/(?<!\*)\*(?!\*)(.+?)(?<!\*)\*(?!\*)/g, '<em>$1</em>')
      .replace(/\n/g, '<br>');

    if (!rawText.trim()) continue;

    html += '<div class="msg">';
    if (isDarenard) {
      html += '<div class="label label-d">DARENARD</div>';
      html += '<div class="d-text">' + rawText + '</div>';
    } else {
      var youLabel = lang === 'en' ? 'YOU' : 'VOUS';
      html += '<div class="label label-u">' + youLabel + '</div>';
      html += '<div class="user-block">' + rawText + '</div>';
    }
    html += '</div>';
  }

  html += '<div class="footer">' + footerText + '</div>';
  html += '</body></html>';

  var w = window.open('', '_blank');
  w.document.write(html);
  w.document.close();
  w.onload = function() {
    setTimeout(function() { w.print(); }, 300);
  };

  btn.classList.remove('exporting');
  btn.textContent = '\u2913 PDF';
}
</script>
</body>
</html>
